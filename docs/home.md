
# О проекте

Простой и минималистичный сервер ActivityPub

**snac** — это легковесная реализация ActivityPub, которая поддерживает как однопользовательскую, так и многопользовательскую настройку. Вы можете взаимодействовать с другими инстансами Федиверса — как приватно, так и публично — без необходимости использования JavaScript, cookies или базы данных.

Работает как демон (через прокси TLS-совместимого HTTP-сервера) и предоставляет базовые функции для инстанса Федиверса / ActivityPub (обмен сообщениями и контентом с другими системами, такими как Mastodon, Pleroma, Friendica и т.д.). 

Программа поддерживает широкий спектр операций ActivityPub и протестирована на совместимость с аналогичным программным обеспечением. Также она включает простой, но эффективный веб-интерфейс с удобно расположенной кнопкой "Заглушить", которая всегда под рукой.

**snac** означает "Social Networks Are Crap" (социальные сети — это дерьмо).

## Возможности

- Легкий, минимум зависимостей
- Широкая поддержка операций ActivityPub, например: писать публичные заметки, подписываться на пользователей, следить за ними, отвечать на заметки других, восхищаться замечательным контентом (ставить лайки или продвигать), писать личные сообщения...
- Многопользовательский
- Поддержка API Mastodon, что позволяет использовать приложения, совместимые с Mastodon.
- Простой, но эффективный веб-интерфейс
- Легкодоступная кнопка MUTE, чтобы заставить замолчать идиотов.
- Проверенная совместимость с соответствующим ПО.
- База данных не требуется
- Полностью без JavaScript
- Никаких файлов cookie тоже
- Не так уж и много ерунды

## Сборка и установка

Эта программа написана на легко переносимом языке C.  Она использует расширение GNU `__attribute__((__cleanup__))`, которое поддерживается как минимум компиляторами C `gcc`, `clang` и `tcc`. Единственными внешними зависимостями являются `openssl` и `curl`.

В Debian/Ubuntu эти требования можно удовлетворить, выполнив:

```bash
apt install libssl-dev libcurl4-openssl-dev
```

В OpenBSD вам просто нужно установить curl:

```bash
pkg_add curl
```

В FreeBSD, чтобы установить `curl`, просто введите:

```bash
pkg install curl
```

В NetBSD для установки `curl` просто введите:

```bash
pkgin install curl
```

Исходный код доступен [здесь](https://codeberg.org/grunfink/snac2).

Запустите `make`, а затем `make install` от имени пользователя root.

Если вы компилируете в NetBSD, вам следует использовать предоставленный Makefile и запустить `make -f Makefile.NetBSD`, а затем `make -f Makefile.NetBSD install` от имени root.

Начиная с версии `2.27`, **snac** включает поддержку API Mastodon; если вас это не интересует, вы можете скомпилировать его, выполнив:

```bash
make CFLAGS=-DNO_MASTODON_API
```

Если процесс компиляции жалуется на неопределённые ссылки `shm_open()` и `shm_unlink()` (такое случается, например, в Ubuntu 20.04.6 LTS), запустите его так:

```bash
make LDFLAGS=-lrt
```

Если ошибки компиляции по-прежнему возникают (поскольку ваша система не реализует функции общей памяти), вы можете исправить это с помощью:

```bash
make CFLAGS=-DWITHOUT_SHM
```

Начиная с версии `2.68`, включена песочница *Linux Landlock* (не поддерживается на ядрах Linux старше 5.13.0). Она все еще немного экспериментальна, поэтому ее необходимо явно скомпилировать с помощью:

```bash
make CFLAGS=-DWITH_LINUX_SANDBOX
```

Начиная с версии `2.73`, язык веб-интерфейса можно настраивать; подкаталог `po/` содержит набор файлов перевода, по одному на каждый язык. После инициализации сервера, скопируйте файл языка, который вы хотите использовать, в подкаталог `lang/` базового каталога.

Подробную информацию о дальнейших действиях см. в [руководстве администратора](#Администрирование). <!-- todo -->

## Тестирование в Docker

Для разработки и тестирования предоставляется файл docker-compose. Чтобы запустить **snac** с использованием HTTPS-интерфейса nginx, выполните:

```bash
docker-compose build && docker-compose up
```

Это позволит:

- Запустить **snac**, сохраняя данные в каталог `data/`
- Настроить **snac** для прослушивания порта `8001` с именем сервера `localhost` (см. `examples/docker-entrypoint.sh`).
- Создать нового пользователя `testuser` и распечатать сгенерированный пароль пользователя в консоли (см. `examples/docker-entrypoint.sh`).
- Запустить nginx для обработки HTTPS, используя пару сертификатов из nginx-alpine-ssl/nginx-selfsigned.* (см. `examples/nginx-alpine-ssl/entrypoint.sh`).

## Интересные ссылки

* Онлайн-версия `man pages` для **snac** (пользователь, администратор и форматы данных) [EN](https://comam.es/snac-doc/).

* Как запустить собственный сервер ActivityPub в OpenBSD с помощью **snac** (by Jordan Reger) [EN](https://man.sr.ht/~jordanreger/activitypub-server-on-openbsd/).

* Установка **snac** в FreeBSD [EN](https://gyptazy.ch/blog/install-snac2-on-freebsd-an-activitypub-instance-for-the-fediverse/)

* Как установить и запустить собственный сервер ActivityPub в FreeBSD, используя **snac**, nginx и let's encrypt [EN](https://gyptazy.ch/blog/install-snac2-on-freebsd-an-activitypub-instance-for-the-fediverse/).

* Список серверов использующих **snac** [fediverse.observer](https://snac.fediverse.observer/list).

* Настройка Snac в OpenBSD (от [Yonle](https://wiki.ircnow.org/index.php?n=Openbsd.Snac)).

* Как запустить собственную социальную сеть с помощью snac (от [Giacomo Tesio](https://encrypted.tesio.it/2024/12/18/how-to-run-your-own-social-network.html)). Включает информацию о том, как запустить snac как CGI.

* Улучшение производительности **snac** с помощью прокси-кэша Nginx (автор Stefano Marinelli).

* Кэширование прокси-медиа Snac с помощью Nginx (автор Стефано Маринелли).

## Темы CSS для snac

* Все доступные [стили оформления](#Темы-оформления).

# Руководство пользователя

Это руководство пользователя предполагает, что у вас уже установлен и работает **snac**. Руководство по администрированию см. раздел [Администрирование](#Администрирование). Информацию о форматировании сообщений и форматах файлов см. раздел [Форматирование сообщений](#Форматирование-сообщений).  

## Веб интерфейс

Веб-интерфейс разделен на два потока данных: общедоступную ленту и личную ленту. Никаких других лент, таких как серверные или федеративные, предоставляемые другими подобными реализациями ActivityPub, такими как Mastodon или Pleroma, не существует.

**Общедоступная лента**, также называемая локальной лентой — это то, что внешний посетитель видит об активности пользователя: то есть только список общедоступных постов, продвижений и лайков, которые пользователь создает или в которых участвует. Эта лента доступна только для чтения. Внизу страницы также будет доступен набор ссылок на историю, сгруппированных по месяцам.

**Личная лента** или просто лента — это частная, защищенная паролем область сервера **snac**, где пользователь взаимодействует с остальной частью Fediverse.

В верхней части ленты есть большое текстовое поле для написания заметок для публики (т.е. для подписчиков пользователя). Оно расположено в самой заметной части страницы пользователя. Вы можете вводить обычный текст, упоминания `@user@host` и другие элементы. Для получения дополнительной информации о допустимых разметках см. раздел [Форматирование сообщений](#Форматирование-сообщений).

Другие поля, сразу под большим текстовым полем ввода, позволяют контролировать отправку сообщения:

- **Sensitive content**  
Если вы установите этот флажок, ваше сообщение будет помечено предупреждением о содержании. Также есть дополнительное текстовое поле, в котором вы можете объяснить, почему ваш контент является чувствительным.

- **Only for mentioned people**  
Если вы установите этот флажок, ваш текст не будет общедоступным, а будет отправлен только тем людям, которых вы упомянули в теле сообщения.

- **Reply to (URL)**  
Если вы заполните это необязательное текстовое поле URL-адресом другого сообщения, ваш текст будет считаться ответом на него, а не отдельным.

**Дополнительные параметры** скрыты под переключателем. Они следующие:

- **Follow (by URL or @user@host)**  
Заполните поле ввода URL-адресом пользовательского 'актора' или идентификатором пользователя `user@host`, на которого хотите подписаться.

- **Boost (by URL)**  
Заполните поле ввода URL-адресом заметки, которую хотите продвинуть.

- **Like (by URL)**  
Заполните поле ввода URL-адресом поста в Федиверс, который вам понравился.

- **User setup...**  
Эта опция открывает диалоговое окно настроек пользователя.

- **Followed hashtags...**  
Введите здесь список хэштегов, на которые вы хотите подписаться, по одному в строке, с символом `#` или без.

- **Blocked hashtags...**  
Введите здесь список хэштегов, которые вы хотите заблокировать, по одному в каждой строке, с символом `#` или без.

Диалоговое окно настроек пользователя позволяет изменить некоторую информацию о пользователе, а именно:

- **User name**  
Ваше имя пользователя, или псевдоним. По какой-то причине, некоторым людям, нравится включать смайлы, флаги и странные символы.

- **Avatar URL**  
URL-адрес изображения, которое будет использоваться в качестве вашего аватара в лентах.

- **Bio**  
Сюда вы можете ввести кучу самодовольных аннотаций о себе. Здесь применяются те же параметры разметки, что и для текстовых заметок.

- **Always show sensitive content**  
По умолчанию контент, помеченный пользователем как деликатный, скрыт. Если вы отметите эту опцию, деликатный контент будет всегда отображаться.

- **Email address for notifications**  
Если это поле не пустое, на этот адрес будет отправлено сообщение электронной почты каждый раз, когда написанный вами пост будет лайкнут, продвинут или на него ответят.

- **Telegram notifications**  
Чтобы включить уведомления через Telegram, заполните два предоставленных поля (ключ API бота и идентификатор чата).
> Для этого вам необходимо создать Telegram-канал и бота, этот процесс довольно громоздкий, но он везде документирован. Ключ API бота представляет собой длинную строку буквенно-цифровых символов, а идентификатор чата — большое отрицательное число.

- **ntfy notifications**  
Чтобы включить уведомления через ntfy (как собственный, так и стандартный сервер ntfy.sh), заполните два предоставленных поля (ntfy сервер/топик и, если защищено, токен).
> Для получения дополнительной информации об этом процессе вам необходимо посетить веб-сайт https://ntfy.sh.

- **Maximum days to keep posts**  
Это числовое значение указывает количество дней, которое пройдет до того, как сообщения (ваши и других) будут удалены. Это значение переопределяет значение, определенное администратором в глобальных настройках сервера, только если оно меньше (т. е. вы не можете хранить сообщения дольше, чем желает администратор). Значение 0 (по умолчанию) означает, что к сообщениям в вашей ленте, будут применяться глобальные настройки сервера.

- **Drop direct messages from people you don't follow**  
Именно то, что и написано (Отклонять личные сообщения от людей, на которых вы не подписаны). Это сделано для уменьшения количества спамеров, приходящих с серверов Федиверс с нестрогой/открытой регистрацией. Обратите внимание, что это также позволит избежать попыток легитимных людей связаться с вами.

- **Auto-boost all mentions to this account**  
Если этот переключатель включен, все упоминания этого аккаунта будут автоматически показаны всем подписчикам. Это можно использовать для создания групп.

- **This account is private**  
Если этот переключатель включен, публикации не будут доступны через общедоступный веб-интерфейс, а будут распространяться только через протокол ActivityPub.

- **Collapse top threads by default**  
Если этот переключатель включен, приватная лента всегда будет показывать треды свернутыми по умолчанию. Это упрощает навигацию по длинным веткам обсуждений.

- **Follow requests must be approved**  
Если этот переключатель включен, запросы на подписку не принимаются автоматически, а уведомляют владельца аккаунта и сохраняются для последующего рассмотрения. Ожидающие запросы на подписку будут отображаться на странице людей для их утверждения или отклонения.

- **Publish follower and following metrics**  
Если этот переключатель включен, количество подписчиков и подписок становится публичным (это только число; конкретные списки аккаунтов никогда не публикуются).

- **Web interface language**  
Если администратор установил какой-либо языковой файл, его можно выбрать здесь.

- **Password**  
Введите одну и ту же строку в эти два поля, чтобы изменить свой пароль. Ничего не пишите, если не хотите менять пароль.

Остальная часть страницы содержит вашу ленту в обратном хронологическом порядке (т.е. сначала самые новые сообщения). Треды отображаются в виде вложенных деревьев, в отличие от другого программного обеспечения Федиверс. Каждый раз, когда вы что-то добавляете в тред, вся ветка поднимается вверх, поэтому новые посты всегда отображаются вверху страницы, а забытые остаются внизу.

Личные сообщения (так называемые прямые сообщения) также отображаются в ленте как обычные сообщения, но помечаются симпатичным замком, чтобы пометить их как непубличные. Ответы на личные сообщения также являются личными, и для них нельзя ставить лайки или продвигать.

Для каждой записи в ленте будет показан набор допустимых действий в виде кнопок. Это могут быть:

- **Reply**  
Открывает текстовую область, где можно написать свой умный и острый комментарий несведущему человеку. Эта заметка отправляется оригинальному автору, а также вашим подписчикам. Заметка может включать упоминания в формате `@user@format`, эти люди также станут получателями сообщения. Если вы отвечаете на продвижение или лайк, вы на самом деле отвечаете на заметку, а не на ее репост.

- **Like**  
Нажмите здесь, если вам нравится этот пост. Автор поста и ваши подписчики будут проинформированы.

- **Boost**  
Нажмите здесь, если хотите распространить этот пост среди всех своих подписчиков. Первоначальный автор также будет проинформирован.

- **Bookmark**  
Нажмите здесь, чтобы добавить пост в закладки.

- **Follow**  
Нажмите здесь, если хотите начать получать все посты, которые изначальный автор поста напишет в будущем.

- **Unfollow**  
Нажмите здесь, если вам надоела деятельность этого человека.

- **Delete**  
Нажмите здесь, чтобы удалить это сообщение. Если это сообщение, написанное вами, остальным участникам отправляется соответствующее оповещение о том, что вы больше не хотите, чтобы ваше сообщение находилась на их серверах (однако не все реализации серверов ActivityPub подчиняются такого рода требованиям).

- **MUTE**  
Это самая важная кнопка в Федиверсе и в целом. Нажмите на нее, если не хотите снова читать чушь от этого пользователя в обозримом будущем. Не бойтесь кнопки `MUTE`.

- **Hide**  
Если беседа становится длинной и раздражающей, но не настолько, чтобы навсегда заглушить его автора, нажмите эту кнопку, чтобы больше не видеть сообщение и его дочерние элементы.

- **Limit**  
Заблокировать анонсы (бусты) от этого пользователя.

- **Edit**  
Сообщения, написанные вами в версии 2.19 и новее, можно редактировать и повторно отправлять получателям.

## Командная строка

Инструмент командной строки предоставляет следующие команды:

- **init** *basedir*  
Инициализирует каталог данных. Это интерактивная команда; будет запрошена необходимая информация. Каталог *basedir* не должен существовать.

- **upgrade** *basedir*  
Обновляет каталог данных после установки новой версии. Необходимо только в случае жалоб и требований.

- **httpd** *basedir*  
Запускает демон.

- **purge** *basedir*  
Удаляет старые данные из ленты всех пользователей.

- **adduser** *basedir* [uid]  
Добавляет нового пользователя на сервер. Это интерактивная команда. Будет запрошена необходимая информация.

- **deluser** *basedir* [uid]  
Удаляет пользователя, предварительно отписавшись от всех аккаунтов.

- **resetpwd** *basedir* [uid]  
Сбрасывает пароль пользователя на новый, случайный.

- **queue** *basedir* [uid]  
Обрабатывает очередь сообщений указанного пользователя, отправляя все поставленные в очередь сообщения и повторно отправляет ошибочные. Эту команду нельзя выполнять, если сервер работает.

- **follow** *basedir* [uid] actor  
Отправляет сообщение `Follow` для указанного URL-адреса актора.

- **request** *basedir* [uid] url  
Запрашивает объект и выводит его на стандартный вывод. Это команда очень низкого уровня, которая не очень полезна для вас.

- **announce** *basedir* [uid] url  
Анонсирует (продвигает) пост через его URL.

- **note** *basedir* [uid] text [file file ...]  
Добавляет сообщение `Create + Note` всем подписчикам. Если аргумент *text* равен `-e`, для подготовки сообщения будет вызван внешний редактор, определенный переменной среды `EDITOR`. Если аргумент `-` (один дефис), содержимое сообщения будет считываться со стандартного потока ввода. Остальные аргументы командной строки рассматриваются как медиафайлы, которые нужно прикрепить к сообщению. Переменная окружения `LANG` (если определена) используется в качестве языка поста.

- **note_unlisted** *basedir* [uid] text [file file ...]  
Как и в предыдущем случае, но при этом создается "unlisted" пост (или "quiet public").

- **note_mention** *basedir* [uid] text [file file ...]  
Аналогичен предыдущему, но создает пост только для аккаунтов, указанных в тексте поста.

- **block** *basedir* instance_url  
Блокирует весь сервер по его URL-адресу или имени домена. Все последующие входящие сообщения с идентификаторами от этого сервера будут немедленно заблокированы без дополнительной проверки.

- **unblock** *basedir* instance_url  
Разблокирует ранее заблокированный сервер.

- **verify_links** *basedir* [uid]  
Проверяет все ссылки, сохраненные в виде метаданных для данного пользователя. Эта проверка выполняется путем загрузки содержимого ссылки и поиска обратной ссылки на URL-адрес пользователя, которая также содержит атрибут `rel="me"`. Эти ссылки специально помечаются как проверенные в публичной ленте пользователя, а также через API Mastodon.

- **export_csv** *basedir* [uid]  
Экспортирует некоторые данные аккаунта в виде CSV-файлов, совместимых с Mastodon. После выполнения этой команды в текущий каталог будут записаны следующие файлы: `bookmarks.csv`, `blocked_accounts.csv`, `lists.csv` и `following_accounts.csv`.

- **alias** *basedir* [uid] __@account@remotehost__  
Устанавливает учетную запись как псевдоним этой. Это необходимый шаг для миграции учетной записи на удаленный экземпляр Mastodon (см. [Миграция из snac в Mastodon](#Миграция-из-snac-в-mastodon)).

- **migrate** *basedir* [uid]  
Начинает миграцию с данной учетной записи на ту, которая установлена ​​в качестве псевдонима (см. [Миграция из snac в Mastodon](#Миграция-из-snac-в-mastodon)).

- **import_csv** *basedir* [uid]  
Импортирует файлы CSV экспортированные из Mastodon. Эта команда ожидает, что следующие файлы будут находиться в подкаталоге `import/`, каталога пользователя в базовом каталоге сервера: `bookmarks.csv`, `blocked_accounts.csv`, `lists.csv` и `following_accounts.csv`.

- **import_list** *basedir* [uid] [file]  
Импортирует список Mastodon в формате CSV. Файл должен храниться в подкаталоге `import/` каталога пользователя в базовом каталоге сервера. Эта опция может быть использована для импорта «Mastodon Follow Packs».

- **import_block_list** *basedir* [uid] [file]  
Импортирует в Mastodon список учетных записей, подлежащих блокировке, в формате CSV. Файл должен храниться в подкаталоге `import/` директории пользователя в базовой директории сервера.

- **state** *basedir*  
Создает дамп текущего состояния сервера и его потоков. Например:

```bash
server: comam.es (snac/2.45-dev)
uptime: 0:03:09:52
job fifo size (cur): 45
job fifo size (peak): 1532
thread #0 state: input
thread #1 state: input
thread #2 state: waiting
thread #3 state: waiting
thread #4 state: output
thread #5 state: output
thread #6 state: output
thread #7 state: waiting
```

Значения размера *fifo* задания показывают текущий и пиковый размеры очереди заданий в памяти. Состояние потока может быть: ожидание (ожидание назначения задания), ввод или вывод (обработка пакетов ввода-вывода) или останов (не выполняется, его можно увидеть только при запуске или остановке сервера).

## Приложения Mastodon

Начиная с версии `2.27`, включена поддержка API Mastodon, поэтому вы можете использовать совместимые с Mastodon мобильные и настольные приложения для доступа к своей учетной записи. При правильно настроенном сервере использование этих программ должно быть простым. Обратите внимание, что приложения будут отображать вашу ленту в «мастодонском стиле» (т. е. в виде простого списка сообщений), поэтому вы потеряете модное вложенное отображение сообщений с наиболее активными темами вверху, которое предоставляет веб-интерфейс. 

## Реализация пост-ботов

Позволяет очень легко публиковать сообщения в неинтерактивной форме. В этом примере публикуется строка, считанная со стандартного потока ввода:

```bash
uptime | snac note $SNAC_BASEDIR $SNAC_USER -
```

Вы можете настроить подобную строку из *crontab* или аналогично. Обратите внимание, что вам необходим:
- доступ из командной строки к тому же компьютеру, на котором размещен сервер
- права на запись в каталоги и файлы хранилища.

Вы также можете публиковать сообщения в неинтерактивном режиме, используя API Mastodon и http инструмент командной строки, например *curl* или аналогичный. Преимущество этого подхода заключается в том, что вы можете сделать это удаленно с любого хоста и в любом месте. Единственное, что вам нужно, это токен API. Вот пример:

```bash
curl -X POST https://$SNAC_HOST/api/v1/statuses \
--header "Authorization: Bearer ${TOKEN}" -d "status=$(uptime)"
```

Вы можете получить токен API, подключившись к следующему URL-адресу:

```
https://$SNAC_HOST/oauth/x-snac-get-token
```
## Переменные окружения

- **SNAC_BASEDIR**  
Эта необязательная переменная окружения, устанавливает базовый каталог вашей установки; если установлено, вам не нужно добавлять базовый каталог в качестве аргумента для операций командной строки. Это может быть полезным, если у вас только один инстанс **snac** в вашей системе (что, вероятно, и есть ваш случай).

- **DEBUG**  
Переопределяет уровень отладки из переменной конфигурации сервера `dbglevel`. Установите для него целочисленное значение. Чем выше, тем глубже вы погружаетесь в кроличью нору.

- **EDITOR**  
Предпочитаемый пользователем интерактивный текстовый редактор для подготовки сообщений.

- **LANG**  
Язык поста при отправке сообщений.

# Форматирование сообщений

В этом руководстве описывается допустимое форматирование сообщений, а также структура каталога данных сервера **snac** и пользовательских данных.

В постах строго соблюдаются переносы строк. Допускается использование специального подмножества `Markdown`, в том числе:

- **bold**  
\*\*текст между двумя парами звездочек\*\*

- **italic**  
\*текст между парой звездочек\* или \_между парой подчеркиваний\_

- **strikethrough text**  
\~~текст между парой тильд\~~

- **underlined text**  
\__текст между двумя парами подчеркиваний\__

- **code**  
Текст \`между обратными кавычками\` форматируется как код

````markdown
```
/* текст между строк с тремя обратными кавычками */
int main(int argc, char *argv[])
    {
        return 0;
    }
```
````

- **links**  
Отдельные URL-адреса преобразуются в ссылки. Также, начиная с версии `2.54`, поддерживаются ссылки в стиле *markdown* в виде **\[текст ссылки\]\(url\)**.

- **Разделители строк**  
Горизонтальную линию можно вставить, набрав три символа тире подряд.

- **quoted text**  
Цитаты, начинаются с `>`.

- **headers**  
Один, два или три символа `#` в начале строки, пробел и некоторый текст преобразуются в заголовки HTML.

- **User Mentions**  
Строки в формате `@user@host` запрашиваются с помощью протокола *Webfinger* и преобразуются в ссылки и упоминания, если найдено что-то разумное.

- **Emoticons / Smileys / Silly Symbols**   

Следующие традиционные смайлы ASCII или специальные строки преобразуются в соответствующие смайлы:

`:-)` `:-D` `X-D` `;-)` `B-)` `:-(` `:-*` `<3` `:-/` `8-o` `%-)` `:_(` `:-|` `>:-(` `: facepalm :` `:shrug:` `:shrug2:` `:eyeroll:` `:beer:` `:beers:` `:munch:` `:thumb:`

?> Примечание: начиная с версии `2.51` эти символы настраиваются администратором сервера, поэтому доступные символы могут отличаться. 

## Допустимый HTML-код

Все HTML-теги в записях исключаются, кроме следующих:

`a` `p` `br` `blockquote` `ul` `ol` `li` `cite` `small` `h2` `h3` `span` `i` `b` `u` `s` `pre` `code` `em` `strong` `hr` `img` `del`

Для вставки изображений, достаточно указать прямую ссылку на изображение:

```
https://url.com/to/file.jpg
```

Количество изображений не ограничено.

# Структура каталога данных

В этом разделе описывается структура каталога данных версии `2.7`.

Базовый каталог содержит следующие файлы и папки:

- **`server.json`**  
Конфигурация сервера.

- **`user/`**  
Каталог, содержащий пользовательские подкаталоги.

- **`object/`**  
Каталог, содержащий объекты ActivityPub. Имена файлов представляют собой хеши каждого идентификатора сообщения, хранящиеся в подкаталогах, начинающихся с первых двух букв хеша.

- **`queue/`**  
Этот каталог содержит глобальную очередь сообщений ввода/вывода в виде файлов JSON. Имена файлов содержат метки времени, указывающие, когда сообщение будет отправлено. Сообщения, не принятые соответствующими серверами, будут повторно поставлены в очередь для последующей повторной передачи до тех пор, пока не будет достигнуто максимальное количество повторов, а затем отброшены.

- **`inbox/`**  
Каталог, в котором хранятся URL-адреса входящих сообщений, полученные из других серверов.

- **`archive/`**  
Если этот каталог существует, все входные и выходные сообщения записываются в него, включая заголовки HTTP. Полезно только для отладки. Может достигать огромных размеров.

- **`error/`**  
Если этот каталог существует, заголовки ошибок проверки подписи HTTP логируются сюда. Полезно только для отладки.

- **`log/`**  
Если этот каталог существует, сообщения журнала также сохраняются в ежедневных файлах.

- **`app/`**  
В этом каталоге хранятся приложения API Mastodon.

- **`token/`**  
В этом каталоге хранятся токены API Mastodon.

- **`style.css`**  
Общесерверный CSS. Содержимое этого файла вставляется в вывод HTML, если только в папке `static/` пользователя не существует файла, специфичного для пользователя.

- **`greeting.html`**  
Этот файл передается, когда запрашивается базовый URL-адрес сервера в браузере. См. snac(8) для получения дополнительной информации о параметрах настройки.

- **`public.idx`**  
Этот файл содержит список публичных сообщений всех пользователей сервера.

- **`filter_reject.txt`**  
Этот (необязательный) файл содержит список регулярных выражений, по одному в строке, которые будут применяться к содержимому всех входящих сообщений; если какой-либо из них совпадает, сообщение отклоняется. Это привносит гибкость и разрушительную силу регулярных выражений в вашу работу с Федиверс. Следует использовать с умом (см. [Защита от спама](#Защита-от-спама))

Каждый пользовательский каталог является подкаталогом `BASEDIR/user/`, имеет идентификатор пользователя в качестве имени и содержит следующие подкаталоги и файлы:

- **`user.json`**  
Файл конфигурации пользователя.

- **`user_o.json`**  
Файл переопределения конфигурации пользователя. Этот файл предназначен для того, чтобы администраторы могли отменить некоторые пользовательские настройки. В текущей версии можно переопределить поля `purge_days` и `email`.

- **`key.json`**  
Данные *PEM* секретного/открытого ключа.

- **`followers.idx`**  
Этот файл содержит список подписчиков в виде списка хешированных идентификаторов объектов.

- **`followers/`**  
В этом каталоге хранятся жесткие ссылки на объекты акторов в хранилище объектов.

- **`following/`**  
В этом каталоге хранятся пользователи, на которых подписаны, в виде жестких ссылок на объекты `Follow` или `Accept` в хранилище объектов. Имена файлов представляют собой хэши идентификаторов каждого актора.

- **`private/`**  
В этом каталоге хранятся жесткие ссылки на записи ленты в хранилище объектов.

- **`private.idx`**  
Этот файл содержит список записей ленты в виде списка хешированных идентификаторов объектов.

- **`public/`**  
В этом каталоге хранятся жесткие ссылки на общедоступные записи ленты в хранилище объектов.

- **`public.idx`**  
Этот файл содержит список записей публичной ленты в виде списка хешированных идентификаторов объектов.

- **`pinned/`**  
В этом каталоге хранятся жесткие ссылки на закрепленные посты.

- **`pinned.idx`**  
Этот файл содержит список закрепленных постов в виде списка хэшированных идентификаторов объектов.

- **`bookmark/`**  
В этом каталоге хранятся жесткие ссылки на посты, добавленные в закладки.

- **`bookmark.idx`**  
Этот файл содержит список закрепленных постов в виде списка хэшированных идентификаторов объектов.

- **`draft/`**  
В этом каталоге хранятся черновики постов.

- **`draft.idx`**  
Этот файл содержит список черновиков в виде списка хешированных идентификаторов объектов.

- **`muted/`**  
Этот каталог содержит файлы, имена которых представляют собой хэши приглушенных акторов. Содержимое представляет собой строку, содержащую URL-адрес актора. Сообщения от этих участников будут игнорироваться при вводе и не отображаются ни в какой ленте.

- **`hidden/`**  
Этот каталог содержит ссылки на скрытые записи ленты.

- **`limited/`**  
Этот каталог содержит ссылки на URL-адреса акторов для ограниченных пользователей (тех, на кого подписаны, но их продвижения заблокированы).

- **`queue/`**  
Этот каталог содержит выходную очередь сообщений, созданных пользователем в виде файлов JSON. Имена файлов содержат метки времени, указывающие, когда сообщение будет отправлено. Сообщения, не принятые соответствующими серверами, будут повторно поставлены в очередь для последующей повторной передачи до тех пор, пока не будет достигнуто максимальное количество повторов, а затем отброшены.

- **`static/`**  
 Файлы в этом каталоге предоставляются «как есть» при запросе по URL-адресу `https://HOST/USER/s/....`. Специальный файл с именем `style.css` может содержать пользовательский CSS-код, который нужно вставить в HTML веб-интерфейса.

- **`history/`**  
Этот каталог содержит сгенерированные файлы HTML. Это могут быть снимки локальной ленты за предыдущие месяцы или другие кэшированные данные.

- **`export/`**  
Эта директория будет содержать экспортированные данные в совместимом с Mastodon формате CSV после выполнения операции командной строки `export_csv`.

- **`import/`**  
Чтобы воспользоваться любой из функций импорта, в эту директорию необходимо скопировать CSV-файлы, совместимые с Mastodon.

- **`server.pid`**  
Данный файл содержит PID сервера в виде одной текстовой строки.

# Администрирование

Это руководство администратора. Руководство пользователя см. [snac(1)](/user-manual/). Информацию о форматировании сообщений и форматах файлов см. в [snac(5)](/formatting-snac/).

## Особеность, о которой следует знать  

**snac** интенсивно использует жесткие ссылки и счетчик ссылок для своей работы, поэтому даже не думайте использовать его в файловой системе, которая не поддерживает эти функции. Большинство UNIX-подобных операционных систем (Linux, BSD, старая машина DEC Ultrix в подвале вашего дедушки, возможно MacOS) поддерживают жесткие ссылки в своих собственных файловых системах. Не делайте таких сложных вещей, как перемещение подкаталогов в разные файловые системы. Кроме того, если вы переносите установку **snac** на другой сервер, делайте это с помощью инструмента, который сохраняет жесткие ссылки, например `tar` или `rsync` с ключом `-H`. Помните: **snac** — очень UNIX-Way программа, которая любит жесткие ссылки.

## Сборка и установка

В системе должен быть установлен компилятор C, а также заголовочные файлы и библиотеки для OpenSSL (или совместимых) и Curl. Чтобы собрать **snac**, выполните:

```bash
make
```

И после этого выполните от имени **root**:

```bash
make install
```

## Инициализация каталога данных

После правильной установки **snac** в системе, назначьте каталог, в котором будут храниться данные сервера и пользователей. Этот каталог еще не должен существовать. **snac** всегда должен запускаться от имени обычного пользователя. Вы можете создать отдельного пользователя для **snac** или использовать свой собственный. Чтобы инициализировать каталог данных, выполните:

```bash
snac init $HOME/snac-data
```

Будет задан небольшой набор вопросов относительно установки, в частности, имя хоста, под которым он будет работать, адрес локальной сети и порт, который будет прослушиваться, необязательный префикс пути и, возможно, другие вещи.

С версии `2.57`, если `network address` начинается с `/`, предполагается, что это UNIX-подобный сокет (обратите внимание, что http-прокси должен иметь полный доступ на чтение и запись к этому сокету; это распространенная ошибка. Разрешения разобьют вам сердце).

Вы можете запустить демон **snac**, выполнив:

```bash
snac httpd $HOME/snac-data
```

Используйте веб-браузер для подключения к указанному адресу и порту. Вы должны увидеть страницу приветствия.

Сообщения журнала отправляются в стандартный поток ошибок. По умолчанию там пишется только актуальная информация. Вы можете повысить уровень отладки, отредактировав поле `dbglevel` в файле `server.json` или установив числовое значение от 0 до 3 для переменной среды `DEBUG`, см. [Переменные окружение](#Переменные-окружение).

Если вы используете систему Linux с поддержкой systemd, OpenBSD, FreeBSD или NetBSD в каталоге примеров есть сценарии запуска и данные конфигурации. Для других операционных систем прочтите соответствующую документацию о том, как установить демон в качестве службы без прав **root**.

## Обновление до новой версии

Иногда структура каталога, для хранения данных, меняется в зависимости от версии. Если произойдет такое изменение, **snac** откажется запускаться и потребует обновления. Сделайте это, выполнив:

```bash
snac upgrade $HOME/snac-data
```

Будьте особенно осторожны, выполняя эту команду обновления, не должно быть каких-либо других процессов, работающих в том же каталоге. Вы можете сломать все. Я знаю это, потому что Тайлер это знает.

## Настройка сервера

HTTP сервер с поддержкой TLS и прокси уже должен быть установлен и настроен. **snac** запускается как демон и прослушивает сокет TCP/IP, желательно локальный интерфейс. Он может обслуживать весь домен или только каталог. HTTP сервер должен быть настроен на маршрутизацию на сокет **snac** всего связанного трафика, а также стандартного адреса *webfinger*. Заголовок `Host` должен быть распространяемый. См. [примеры](#Примеры) ниже.

## Добавление пользователей

Пользователей необходимо создавать из командной строки. Вы можете сделать это, выполнив:

```bash
snac adduser $HOME/snac-data
```

## Кастомизация

Конфигурационный файл `server.json` позволяет настроить некоторое поведение:

- **host**  
Имя хоста.

- **prefix**  
Префикс URL-адреса.

- **address**  
Прослушиваемый сетевой адрес. Если он начинается с `/`, то предполагается, что это UNIX-подобный сокет.

- **port**  
Прослушиваемый сетевой порт (не используется, если адрес представляет собой сокет UNIX).

- **dbglevel**  
Уровень отладки. Целочисленное значение меньше 0, чем меньше, тем более подробно (по умолчанию 0).

- **layout**  
Версия структуры каталога данных. Никогда не трогайте это.

- **queue_retry_max**  
Отправленные сообщения сохраняются в очереди. Если не удалось опубликовать сообщение, оно снова помещается в очередь на более позднее время. Это целое число определяет максимальное количество повторных попыток отправки.

- **queue_retry_minutes**  
Количество минут ожидания перед повторной попыткой отправки неудачной публикации сообщения. Это значение не является линейным, а умножается на количество уже выполненных попыток.

- **queue_timeout**  
Максимальное количество секунд ожидания при отправке сообщения из очереди.

- **queue_timeout_2**  
Максимальное количество секунд ожидания при отправке сообщения из очереди на те серверы, у которых истек таймаут при предыдущей повторной попытке. Если вы хотите дать медленным серверам возможность получать ваши сообщения, вы можете увеличить это значение (но также учтите, что обработка очереди займет больше времени в ожидании ответа).

- **max_timeline_entries**  
Это максимальное количество записей в ленте, отображаемых в веб-интерфейсе.

- **timeline_purge_days**  
Записи в ленте старше этого количества дней удаляются. Если вы не хотите очищать ленту и наслаждаться тем, что ваши диски с данными заполняются старым дерьмом и, наконец, загораются, вы можете отключить очистку, установив для этого параметра значение 0.

- **local_purge_days**  
То же, что и раньше, но для записей, созданных пользователем, в локальной ленте.

- **cssurls**  
Это список URL-адресов файлов CSS, которые будут вставлены, в этом порядке, в HTML перед пользовательским CSS. Используйте эти файлы для настройки глобального макета сайта.

- **disable_cache**  
Если установлено значение `true`, кэширование ленты не выполняется. Это полезно только для целей отладки. Не включайте его, если не знаете, чего хотите, так как это замедляет работу.

- **disable_openbsd_security**  
При работе под OpenBSD **snac** использует расширенные функции безопасности `unveil(2)` и `pledge(2)`. Установка значения `true`, отключает их использование. Эти функции сильно ограничивают возможности злоумышленника в случае уязвимости безопасности, поэтому включайте эту опцию только в том случае, если что-то сильно сломано.

- **num_threads**  
Установив это значение, вы можете указать точное количество потоков, которые **snac** будет использовать при обработке соединений. Значения меньше 4 будут игнорироваться.

- **disable_email_notifications**  
Если для этого параметра установлено значение `true`, уведомления по электронной почте не будут отправляться пользователям.

- **disable_inbox_collection**  
Если для этого параметра установлено значение `true`, сбор `inbox` сообщений не осуществляется. Сбор `inbox` сообщений помогает обнаружению их на удаленных серверах, но также увеличивает сетевой трафик.

- **http_headers**  
Если по какой-то причине вам нужно добавить дополнительные заголовки HTTP-ответа, вы можете заполнить этот объект необходимыми парами заголовок/значение.

- **show_instance_timeline**  
Если для этого параметра установлено значение `true`, на базовом URL-адресе сервера будет отображаться лента с последними сообщениями пользователей вместо статической страницы приветствия по умолчанию. Если установлены другие информационные поля (см. ниже), они также отображаются.

- **admin_email**  
Адрес электронной почты администратора сервера (необязательно).

- **admin_account**  
Имя пользователя администратора сервера (необязательно).

- **short_description**  
Текстовое краткое описание сервера (необязательно).

- **fastcgi**  
Если установлено значение `true`, **snac** будет использовать интерфейс FastCGI для связи с http-сервером верхнего уровня, который необходимо настроить соответствующим образом.

- **disable_history**  
Если установлено значение `true`, ежемесячные снимки истории не создаются и их ссылки не отображаются.

- **shared_inboxes**  
Это логическое значение определяет, будут ли анонсированы общие `inboxes` или нет. Включение общих `inboxes` помогает (в некоторой степени) оптимизировать входящий трафик для серверов с большим количеством пользователей.

- **min_account_age**  
Если это числовое значение (в секундах) установлено, любая активность, исходящая из учетной записи, созданной позднее, будет отклонена. Это можно использовать для предотвращения спама от автоматически созданных учетных записей.

- **protocol**  
Это строковое значение содержит протокол который будет использоваться в URL-адресах. Если не установлено, по умолчанию используется «https». Если вы запускаете **snac** как часть скрытой сети, например Tor или I2P, которые не имеет инфраструктуры TLS/сертификатов, вам необходимо установить значение «http». Не меняйте этот параметр, если не знаете, что делаете.

- **hide_delete_post_button**  
Если установлено значение `true`, кнопка удаления поста не отображается. Это не очень полезно и немного загромождает и без того переполненное пространство кнопок.

- **disable_block_notifications**  
Если установлено значение true, уведомления о действиях 'Block' никогда не отправляются.

- **strict_public_timelines**  
Если установлено в true, публичные ленты показывают только посты и продвижения, созданные от аккаунта (без дерева обсуждений).

- **proxy_media**  
Если установлено значение true, ссылки на все изображения, аудио или видео из постов других аккаунтов не будут прямыми, а будут проксированы. Таким образом, удаленные серверы не будут видеть IP пользователя, а только серверный, что улучшает конфиденциальность. Пожалуйста, обратите внимание, что это увеличит входящий и исходящий трафик сервера.

- **badlogin_retries**  
Если количество неверных попыток входа с определенного IP-адреса достигает этого значения, последующие попытки с этого адреса отклоняются до истечения срока блокировки (по умолчанию: 5 попыток).

- **badlogin_expire**  
Количество секунд, в течение которых заблокированный IP-адрес игнорируется при попытках входа в систему (по умолчанию: 300 секунд).

- **disable_sandbox**  
Этот логический переключатель позволяет отключить песочницу *Linux Landlock*. Заключение программы в песочницу ограничивает каталоги и ресурсы, которые она может использовать, поэтому рекомендуется для безопасности. Поддержка песочницы Linux должна быть скомпилирована, и вам потребуется как минимум ядро ​​Linux версии 5.13.0.

- **max_public_entries**  
Максимальное количество записей (постов), которые будут возвращены в пользовательских RSS-каналах и исходящих (по умолчанию: 20).

- **max_attachments**  
Максимальное количество вложений в одном посте (по умолчанию: 4).

- **enable_svg**  
Начиная с версии `2.73`, вложения SVG изображений по умолчанию скрыты; вы можете включить их, установив это значение в `true`.

?> Cервер необходимо перезагрузить, чтобы изменения вступили в силу.

Если файл с именем `Greeting.html` присутствует в базовом каталоге сервера, он будет возвращаться всякий раз, когда запрашивается базовый URL-адрес сервера. Заполните его любой информацией о вашем инстансе, которую вы хотите предоставить людям, посещающим сервер, например, требования к регистрации, политики сайта и тому подобное. Специальная отметка `%userlist%` в файле приведет к вставке списка пользователей этого сервера.

Пользователи могут изменить некоторую информацию о себе из веб-интерфейса. Подробности смотрите в [рукводстве пользователя](#Веб-интерфейс). Кроме того, каждый пользователь может иметь собственный CSS-файл в своем `static/style.css`, который будет обслуживаться вместо общесерверного. Его нельзя изменить из веб-интерфейса, чтобы пользователи не выстрелили себе в ногу, уничтожив всё.

## Пользовательские эмодзи  

Начиная с версии `2.51`, доступна поддержка настраиваемых эмодзи в сообщениях (ранее они были жестко закодированы). Эмодзи считываются из файла `emojis.json` в базовом каталоге сервера, как объект JSON из пар ключ/значение (если этот файл не существует, он будет создан с набором по умолчанию). Каждый ключ в объекте содержит текст, который необходимо найти (например, `:-)` для улыбающегося лица), и связанное с ним значение (текстовая строка), которая заменит его (в данном примере — HTML-объект Юникода для смайлика или сам эмодзи в текстовом виде).

Значения эмодзи, также могут быть URL-адресами на файл изображения; в этом случае они не будут заменены в содержимом сообщения, а добавлены в массив `tag`, как стандартный объект ActivityPub `Emoji` (рекомендуется заключать ключ `Emoji` в двоеточия для максимальной совместимости с другими реализациями ActivityPub, например:`:happydoggo:`). Эти изображения могут предоставляться из внешнего источника или из статического каталога администратора сервера.

Если вы хотите отключить любую замену эмодзи, оставьте ее как файл размером 0 байт или с пустым объектом JSON `({})`.

## Защита от спама  

В сети Федиверс было несколько спам-атак, и поскольку слишком много инстансов и реализаций серверов по-прежнему допускают автоматическое создание учетных записей, ситуация будет только ухудшаться. **snac** включает в себя некоторые (не очень мощные) инструменты для того, чтобы попытаться пережить поток спама.

Поле `min_account_age` в основном файле конфигурации позволяет установить минимальный возраст (в секундах), чтобы считать слишком недавно созданные учетные записи подозрительными как потенциальный источник СПАМА. Это наивное предположение, поскольку спамеры могут создать учетные записи, оставить их на некоторое время бездействующими, а затем начать ими пользоваться. Кроме того, некоторые реализации ActivityPub даже не возвращают дату создания своих учетных записей, так что это не очень полезно.

Начиная с версии `2.50`, содержимое постов можно фильтровать с помощью регулярных выражений. Эти "оружия массового поражения" можно записать в файл `filter_reject.txt` в базовой директории сервера, по одному выражению на строку. Если этот файл существует, содержимое всех постов (после удаления HTML-тегов) будет проверяться на соответствие каждому из этих регулярных выражений по очереди, и любое совпадение приведёт к отклонению поста. Используйте нижний регистр — регулярные выражения по умолчанию нечувствительны к регистру.

Если вы не разбираетесь в регулярных выражениях, лучше не используйте эту функцию (или сначала изучите их — в интернете полно обучающих материалов). В противном случае вы и ваши пользователи рискуете начать пропускать важные сообщения. Также учтите, что разные реализации регулярных выражений поддерживают разные наборы функций, поэтому рекомендуется ознакомиться с документацией именно той версии, которая используется в вашей системе.

## Поддержка ActivityPub  

**snac** поддерживает следующие действия и объекты:

- **`Follow`**  
Полная поддержка, как на входе, так и на выходе.

- **`Undo`**  
Для объектов `Follow`, `Like` и `Announce` на входе и выходе.

- **`Create`**  
Для объектов `Note`, `Question`, `Page`, `Article`, `Event` и `Video` на входе, а для `Note` и `Question` на выходе.

- **`Accept`**  
Для объектов `Follow` на входе и выходе.

- **`Like`**  
Для объектов `Note` на входе и выходе.

- **`EmojiReact`**  
Для объектов `Note`, на входе.

- **`Announce`**  
Для объектов `Note` на входе и выходе.

- **`Update`**  
Для объектов `Note`, `Question`, `Page`, `Article`, `Event` и `Video` на входе, а для `Note` на выходе.

- **`Delete`**  
Поддерживается для объектов `Note` и `Tomsbtone` на входе, а также для объектов `Note` на выходе.

- **`Move`**  
Для объектов, подобных акторам, на входе и выходе.

Остальные действия и объекты отбрасываются при вводе.

Существует частичная поддержка объектов `OrderedCollection` в `/outbox` (с отображением последних 20 записей локальной ленты). Пагинация не поддерживается. Пути `/followers` и `/following` намеренно возвращают пустые списки.

## Миграция из snac в Mastodon

Начиная с версии `2.60`, вы можете мигрировать свою учетную запись **snac** на другие серверы ActivityPub.  То, что здесь описано, — это процесс миграции с **snac** на Mastodon; в других программных реализациях это, безусловно, будет несколько иначе. Все шаги, касающиеся вашей учетной записи **snac**, должны выполняться из командной строки.  Для примера предположим, что вы хотите мигрировать с учетной записи под названием `@origin@snac.example.org` на другую учетную запись под названием `@destination@mastodon.example.com`, и что обе они уже существуют. Я использовал эту очень информативную страницу в качестве руководства:

https://fedi.tips/transferring-your-mastodon-account-to-another-server/

1. На вашем snac сервере сначала экспортируйте данные в CSV, выполнив:

```bash
snac export_csv $SNAC_BASEDIR origin
```

Вы найдете следующие CSV файлы в подкаталоге `export/` внутри каталога пользователя: `bookmarks.csv`, `blocked_accounts.csv`, `lists.csv` и `following_accounts.csv`.

2.  В веб-интерфейсе вашей новой учетной записи Mastodon нажмите на `Настройки` > `Импорт и экспорт` > `Импорт` и загрузите файлы CSV по одному. Вы должны указать тип файла, который вы загружаете.

3. Все еще в веб-интерфейсе вашей новой учетной записи Mastodon, нажмите на `Настройки` > `Учетная запись` > `Переход с другой учетной записи`, затем нажмите на `Создать псевдоним учетной записи` и следуйте инструкциям. (Когда вас попросят ввести имя вашей старой учетной записи, оно должно включать `@` в начале, а также `@` посередине; в нашем примере, `@origin@snac.example.org`).  Похоже, этот шаг не выполняется немедленно, вам нужно подождать неопределенное количество минут, чтобы это вступило в силу.

4. Тем временем, вы должны сообщить **snac** о вашей новой учетной записи, создав псевдоним от вашей текущей.
Итак, на вашем **snac** сервере выполните:

```bash
snac alias $SNAC_BASEDIR origin "@destination@mastodon.example.com"
```

5. Наконец, вы должны приказать **snac** начать процесс миграции, который будет состоять из итерации всех людей, которые подписаны на ваш аккаунт, и отправки им сообщения `Move`, которое действует как предложение отписаться от вашего старого аккаунта и подписаться на новый. Команда:

```bash
snac migrate $SNAC_BASEDIR origin
```

Этот процесс может быть очень долгим и ненадежным; любой сервер назначения может быть недоступен, слишком загружен, отключен или исчезнуть. Я рекомендую вам прочитать документ, ссылку на который я привел выше, чтобы узнать обо всех бедах, которые вас ожидают.

Также, обратите внимание, что учетная запись **snac**, с которой вы мигрировали, не отключена и не изменена каким-либо образом, поэтому вы можете продолжать использовать ее, так как миграция не была выполнена. Это поведение может совпадать или не совпадать с тем, что делают другие реализации ActivityPub.

?> **ПРИМЕЧАНИЕ:** Если вы работаете в OpenBSD, обратите внимание, что система безопасности `pledge()/unveil()` запрещает открывать или создавать файлы в текущем каталоге; чтобы выполнить эту операцию, пожалуйста временно установите опцию `disable_openbsd_security` в `true` в файле `server.json` и перезагрузитесь перед миграцией. После этого вы можете вернуть опцию к значению `false` по умолчанию.

## Миграция из Mastodon в snac  

Начиная с версии `2.61`, вы можете переносить учетные записи из других серверов ActivityPub в ваш инстанс **snac**. Здесь описан процесс, как это сделать из Mastodon; в других реализациях программного обеспечения это, безусловно, будет несколько отличаться. Все шаги, касающиеся вашей учетной записи **snac**, должны выполняться из командной строки. Для примера предположим, что вы хотите перенести учетную запись с именем `@origin@mastodon.example.com` на другую учетную запись с именем `@destination@snac.example.org`, и что обе они уже существуют. Я использовал эту очень информативную страницу в качестве руководства:

https://fedi.tips/transferring-your-mastodon-account-to-another-server/

1. В веб-интерфейсе вашего исходного аккаунта Mastodon нажмите `Настройки` > `Импорт и экспорт` > `Экспорт` и загрузите файлы CSV под названием `Follows`, `Lists`, `You Block` и `Bookmarks` . После загрузки вы должны найти следующие файлы в каталоге загрузки: `bookmarks.csv`, `blocked_accounts.csv`, `lists.csv` и `following_accounts.csv`.

2. Скопируйте все эти файлы в подкаталог `import/` каталога пользователя внутри базового каталога сервера и выполните команду:

```bash
snac import_csv $SNAC_BASEDIR destination
```

Этот процесс может занять некоторое время, поскольку он зависит от доступности/отзывчивости всех задействованных серверов ActivityPub (webfinger, учетные записи, сообщения и т. д.). Некоторые ошибки могут быть временными и повторяться позже. Кроме того, если **snac** жалуется, что не может найти ни один из этих файлов, проверьте, что они действительно сохранены в подкаталоге `import/` и их имена точно совпадают. Некоторые из них могут быть пустыми (например, если вы не создавали никаких списков), и это нормально.

3. Снова на вашем сервере **snac** запустите:

```bash
snac alias $SNAC_BASEDIR destination "@origin@mastodon.example.com"
```

Проверьте, что не было показано никаких ошибок. Если они есть, исходный сервер Mastodon может быть занят или отключен; попробуйте позже.

4. Вернитесь в веб-интерфейс исходной учетной записи Mastodon, перейдите в `Preferences` > `Account` > `Move To A Different Account` и следуйте инструкциям. Установите дескриптор новой учетной записи на ваш **snac**; в нашем примере `@destination@snac.example.org`. Это запустит процесс миграции: обязанность вашего старого экземпляра Mastodon — отправлять автоматическое сообщение `Move` каждому из ваших подписчиков. В конце концов вы начнете получать уведомления о подписках на вашу учетную запись **snac** от всех учетных записей, которые подписались на Mastodon. Согласно замечательному документу, ссылку на который я привел выше, этот процесс может начаться или не начаться немедленно, и его успех может сильно зависеть от того, как ведут себя все задействованные серверы. Просто скрестите пальцы и надейтесь на лучшее.

## Блокировка сервера  

Серверы полностью могут быть заблокированы. Эту операцию необходимо выполнить с помощью инструмента командной строки. См. [Командная строка)](#Командная-строка).

## Ограничение на попытки входа  

Начиная с версии `2.67`, реализована простая логика для предотвращения атак методом подбора паролей пользователей: если с заданного IP-адреса количество неудачных попыток входа достигает заданного порога, дальнейшие попытки с этого IP-адреса отклоняются, пока не истечет таймер. Максимальное количество повторных попыток можно настроить в файле `server.json`, установив переменную `badlogin_retries`, а количество секунд, в течение которых истекает таймер разблокировки IP-адреса, в `badlogin_expire`. Обратите внимание, что для работы этой системы необходимо настроить прокси-сервер веб-сервера для передачи адреса удаленного подключения в HTTP-заголовке `X-Forwarded-For` (если вы не используете интерфейс FastCGI; в этом случае вам не нужно ничего делать).

## Подписка на ретрансляторы  

Начиная с версии `2.69`, инстансы **snac** могут подписываться на федиверс ретрансляторы *LitePub* (в стиле Pleroma). Это улучшает видимость и позволяет отслеживать хэштеги. Для этого необходимо создать специального пользователя с именем `relay` и от него следить за акторами ретранслятора, как вы делаете с обычными URL-адресами акторов. Этот специальный пользователь начнет получать продвижения от сервера ретрансляции сообщений из других инстансов, также подписанных на него. Если любой другой пользователь того же экземпляра **snac** подпишется на любой из хэштегов, включенных в эти продвигаемые посты, поступающие от ретранслятора, они будут восприняты так, как если бы они были предназначены для него.

Пример:

```bash
snac adduser $SNAC_BASEDIR relay # only needed once
snac follow $SNAC_BASEDIR relay https://relay.example.com/actor
```

?> Пользователям вашего экземпляра **НЕ НУЖНО** подписываться на локального пользователя-ретранслятора, чтобы воспользоваться возможностью подписки на хэштеги.

Обратите внимание, что подписка на ретрансляторы может значительно увеличить трафик к вашему серверу. В любом случае рекомендуется снизить значение "Максимальное количество дней для хранения сообщений" для специального пользователя `relay` (например, установить всего 1 день).

## Язык веб-интерфейса  

Начиная с версии `2.73`, веб-интерфейс можно локализовать с помощью простых файлов .po (они анализируются напрямую, поддержка gettext не требуется).

По умолчанию языковые файлы не устанавливаются; администратор должен скопировать любые нужные `.po` файлы в подкаталог `lang/` в базовом каталоге. После перезапуска сервера, пользователи могут выбрать новый язык в настройках. Дистрибутив исходного кода **snac** может включать файлы `.po` в подкаталоге `po/`. Вам не нужно копировать английский язык, так как он используется по умолчанию.

Чтобы создать новые языковые файлы, создайте копию `po/en.po`, переименуйте ее в подходящее значение, например `pl.po` или `pt_BR.po`, измените переводчика в заголовке на себя и заполните строки `msgstr` своим переводом. Если у вас есть какие-либо сомнения относительно того, как изменять `.po` файлы, существует множество руководств. Если вы хотите, чтобы ваш языковой файл был включен в стандартный дистрибутив **snac**, отправьте мне ссылку на него через Fediverse на *@grunfink@comam.es* или сделайте PR через репозиторий Git.

## Примеры

Вы хотите установить демон **snac** на хосте *example.com*, который правильно настроен, с действительным сертификатом TLS и на котором запущен сервер nginx. Демон будет установлен в папке `fedi`. В системе будут созданы два пользователя, *Уолтер* и *Джесси*. Их адреса присутствия в Fediverse будут *https://example.com/fedi/walter* и *https://example.com/fedi/jesse* соответственно. Они будут известны в Федиверс как *@walter@example.com* и *@jesse@example.com*. Демон **snac** будет работать в системе от имени пользователя `snacusr` и прослушивать сетевой сокет `localhost:8001`. Все данные будут храниться в каталоге `/home/snacusr/fedidata`.

Войдите в систему как `snacusr` и выполните:

```bash
snac init /home/snacusr/fedidata
```

Ответьте `example.com` на вопрос об имени хоста, `/fedi` на вопрос о префиксе пути, `localhost` на адрес и `8001` на порт.

Создайте пользователей:

```bash
snac adduser /home/snacusr/fedidata walter
snac adduser /home/snacusr/fedidata jesse
```

Ответьте на вопросы, указав разумные значения.

Запустите сервер:

```bash
snac httpd /home/snacusr/fedidata
```

Отредактируйте конфигурацию nginx и добавьте следующий фрагмент в раздел сервера *example.com*:

```nginx
# nginx configuration example

# main web access point
location /fedi {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

# webfinger
location /.well-known/webfinger {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

# Mastodon API (entry points)
location /api/v1/ {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

location /api/v2/ {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

# Mastodon API (OAuth support)
location /oauth {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

# optional
location /.well-known/nodeinfo {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
}

# optional (needed by some Mastodon API clients)
location /.well-known/host-meta {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

# optional (Mastodon-like link share entrypoint)
location /share {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

# optional (Mastodon-like "authorize interaction" entrypoint)
location /authorize_interaction {
    proxy_pass http://localhost:8001;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $remote_addr;
}
```

Перезапустите демон nginx и подключитесь к *https://example.com/fedi/walter*. Будет показан пустой экран по умолчанию. Войдите в раздел администратора, используя учетные данные, определенные для этого пользователя. Ищите людей, подписывайтесь на них, участвуйте в душных дискуссиях и вообще наслаждайтесь разочаровывающими впечатлениями от социальных сетей.

Это пример аналогичной конфигурации для веб-сервера Apache2:

```apacheconf
# apache2 configuration example

ProxyPreserveHost On

# Main web access point
<Location /social>
    ProxyPass http://127.0.0.1:8001/social
</Location>

# WebFinger
<Location /.well-known/webfinger>
    ProxyPass http://127.0.0.1:8001/.well-known/webfinger
</Location>

# Mastodon API (entry points)
<Location /api/v1/>
    ProxyPass http://127.0.0.1:8001/api/v1/
</Location>

<Location /api/v2/>
    ProxyPass http://127.0.0.1:8001/api/v2/
</Location>

# Mastodon API (OAuth support)
<Location /oauth>
    ProxyPass http://127.0.0.1:8001/oauth
</Location>

# NodeInfo (optional)
<Location /.well-known/nodeinfo>
    ProxyPass http://127.0.0.1:8001/.well-known/nodeinfo
</Location>

# host-meta (optional, needed for some Mastodon API clients)
<Location /.well-known/host-meta>
    ProxyPass http://127.0.0.1:8001/.well-known/host-meta
</Location>

# optional (Mastodon-like link share entrypoint)
<Location /share>
    ProxyPass http://127.0.0.1:8001/share
</Location>

# optional (Mastodon-like "authorize interaction" entrypoint)
<Location /authorize_interaction>
    ProxyPass http://127.0.0.1:8001/share
</Location>
```

Начиная с версии `2.43`, **snac** поддерживает связь с/от внешнего HTTP сервера с использованием протокола FastCGI. Особого преимущества в этом нет, просто некоторые серверы допускают более простую настройку. Например, в случае nginx вы можете заменить две строки `proxy_pass` и `proxy_set_header` в приведенном выше примере, на:

```nginx
fastcgi_pass localhost:8001;
```

Единственное, что нужно изменить в конфигурации **snac**, — это установить для параметра `fastcgi` значение `true` в файле `server.json`.

Кроме того, использование интерфейса FastCGI позволяет гораздо проще настроить в OpenBSD нативный `httpd`, поскольку он там реализован изначально и вам больше не нужно настраивать сложный ретрансляционный сервер. Вот пример:

```nginx
# OpenBSD httpd configuration example

# other server configuration
[...]

location "/fedi/" {
    fastcgi socket tcp "127.0.0.1" 8001
}

location "/.well-known/webfinger" {
    fastcgi socket tcp "127.0.0.1" 8001
}

location "/oauth/*" {
     fastcgi socket tcp "127.0.0.1" 8001
}

location "/api/v1/*" {
    fastcgi socket tcp "127.0.0.1" 8001
}

location "/api/v2/*" {
    fastcgi socket tcp "127.0.0.1" 8001
}

location "/.well-known/nodeinfo" {
     fastcgi socket tcp "127.0.0.1" 8001
}

location "/.well-known/host-meta" {
    fastcgi socket tcp "127.0.0.1" 8001
}

location "/share" {
    fastcgi socket tcp "127.0.0.1" 8001
}

location "/authorize_interaction" {
    fastcgi socket tcp "127.0.0.1" 8001
}
```

# Темы оформления

?> Ниже представлены все существующие на данный момент темы для `snac`. Если вы нашли новую тему или создали свою, сообщите об этом *(Fediverse: @voron@no.run.place / Mail: voron@no.run.place)*, чтобы добавить её здесь.  


### Pika

![Pika](https://codeberg.org/voron/snac-style/raw/branch/master/pika.png ':size=80%')  
[Скачать](https://codeberg.org/voron/snac-style/raw/branch/master/pika.css)

### Next

![Next](https://codeberg.org/voron/snac-style/raw/branch/master/next.png ':size=80%')  
[Скачать](https://codeberg.org/voron/snac-style/raw/branch/master/next.css)

### Paper Dark   

![Paper dark](https://codeberg.org/voron/snac-style/raw/branch/master/paper-dark.png ':size=80%')  
[Скачать](https://codeberg.org/voron/snac-style/raw/branch/master/paper-dark.css)

### Paper  

![Paper](https://codeberg.org/voron/snac-style/raw/branch/master/paper.png ':size=80%')  
[Скачать](https://codeberg.org/voron/snac-style/raw/branch/master/paper.css)

### Modern Dark  

![Modern Dark](https://codeberg.org/voron/snac-style/raw/branch/master/modern-dark.png ':size=80%')  
[Скачать](https://codeberg.org/voron/snac-style/raw/branch/master/modern-dark.css)

### Modern  

![Screenshot](https://codeberg.org/voron/snac-style/raw/branch/master/9ec83c4769bff7ab41ef3ae6bffac9f0.png ':size=80%')  
[Скачать](https://codeberg.org/voron/snac-style/raw/branch/master/modern.css)

### White  

![Screenshot](https://codeberg.org/voron/snac-style/raw/branch/master/white-snac.png ':size=80%')  
[Скачать](https://codeberg.org/voron/snac-style/raw/branch/master/white.css)

### Ember (by `@paul@snac.notnull.space`)  

![Ember](https://codeberg.org/voron/snac-style/raw/branch/master/ember.png ':size=80%')  
[Скачать](https://codeberg.org/pswilde/snac-ember/src/branch/master/style.css)

### Haijo7 (by `@Haijo7@snac.haijo.eu`)  

![Haijo7](https://codeberg.org/voron/snac-style/raw/branch/master/haijo7.png ':size=80%')  
[Скачать](https://codeberg.org/Haijo7/snac-custom-css/src/branch/main/style.css)

### Terminal (by `@tetra@meowcity.club`)  

![Terminal](https://codeberg.org/voron/snac-style/raw/branch/master/terminal.png ':size=80%')  
[Скачать](https://codeberg.org/ERROR404NULLNOTFOUND/snac-terminal-theme/src/branch/main/style.css)

### Lowkey Cyber dark (by `@swansinflight@snac.lowkey.party`)  

![Lowkey Cyber dark](https://codeberg.org/voron/snac-style/raw/branch/master/lowkey-cyber-dark.png ':size=80%')  
[Скачать](https://codeberg.org/swansinflight/snac-css/src/branch/main/lowkey-cyber-dark.css)

### Gruvbox (by `@nigel@snac.lowkey.party`)  

![Gruvbox](https://codeberg.org/voron/snac-style/raw/branch/master/gruvbox.png ':size=80%')  
[Скачать](https://codeberg.org/swansinflight/snac-css/src/branch/main/gruvbox.css)

# Лицензия

Подробности смотрите в файле [LICENSE](https://codeberg.org/grunfink/snac2/src/branch/master/LICENSE).

# Автор

grunfink [@grunfink@comam.es](https://comam.es/snac/grunfink)

Купите grunfink'у кофе: https://ko-fi.com/grunfink/

Сделайте пожертвование через LiberaPay: https://liberapay.com/grunfink/

# Баги

Наверное, много. Некоторые проблемы могут быть даже задокументированы в файле [TODO.md](https://codeberg.org/grunfink/snac2/src/branch/master/TODO.md).
